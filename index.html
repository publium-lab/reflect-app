<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#000000"/>
  <meta name="description" content="REFLECT ‚Äî une app d'introspection guid√©e."/>
  <title>REFLECT</title>
  <link rel="manifest" href="manifest.json"/>
  <style>
    :root {
      --bg: #000;
      --panel: #111;
      --text: #fff;
      --muted: #a5a5a5;
      --line: #333;
      --primary: #fff;
      --primaryText: #000;
      --danger: #ff5d5d;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 24px;
      max-width: 720px;
      margin-inline: auto;
    }

    h1 { margin: 0 0 8px; font-size: 32px; }
    p { color: var(--muted); margin-top: 0; }

    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      background: #070707;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 12px;
      border-radius: 8px;
      font: inherit;
    }

    .row { display: grid; gap: 10px; margin-top: 12px; }
    @media (min-width: 600px) { .row.modes { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    button {
      width: 100%;
      padding: 13px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: 120ms ease;
    }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
    .primary { background: var(--primary); color: var(--primaryText); border: none; }
    .active { outline: 2px solid #fff; }

    .status {
      min-height: 24px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
    }
    .status.error { color: var(--danger); }

    .response {
      margin-top: 16px;
      white-space: pre-wrap;
      line-height: 1.6;
      border-left: 3px solid var(--line);
      padding-left: 10px;
    }

    .list { margin: 0; padding-left: 18px; }
    .list li { margin-bottom: 10px; color: #ddd; }

    .topbar {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .small { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>REFLECT</h1>
    <button id="clearHistoryBtn" type="button" aria-label="Effacer l'historique">Effacer</button>
  </div>
  <p>The truth you avoid.</p>

  <section class="card">
    <label for="input">√âcris une situation, une pens√©e ou un doute :</label>
    <textarea id="input" placeholder="Ex : Je repousse toujours le moment de r√©pondre √† ce message..."></textarea>

    <div class="row modes" id="modes"></div>

    <button class="primary" id="reflectBtn" type="button">REFLECT</button>
    <div id="status" class="status" role="status" aria-live="polite"></div>
    <div class="response" id="output"></div>
  </section>

  <section class="card">
    <h3>History</h3>
    <ul id="history" class="list"></ul>
    <p class="small">Limite gratuite : <span id="remaining"></span></p>
  </section>

  <script>
    const CONFIG = {
      LIMIT: 2,
      API_URL: "https://reflect-api.publium-ai.workers.dev/",
      MODEL: "gpt-4o-mini",
      STRIPE_LINK: "https://buy.stripe.com/test_dRm7sK562dUo2eubnm6Na00",
      STORAGE_KEYS: {
        count: "reflect_count",
        history: "reflect_history",
        mode: "reflect_mode",
        apiKey: "REFLECT_API_KEY"
      }
    };

    const MODES = [
      { id: "soft", label: "Soft Truth", locked: false },
      { id: "brutal", label: "Brutal Honesty üîí", locked: true },
      { id: "sabotage", label: "Self-Sabotage üîí", locked: true },
      { id: "relationship", label: "Relationship Reality üîí", locked: true }
    ];

    const inputEl = document.getElementById("input");
    const outputEl = document.getElementById("output");
    const historyEl = document.getElementById("history");
    const reflectBtn = document.getElementById("reflectBtn");
    const statusEl = document.getElementById("status");
    const remainingEl = document.getElementById("remaining");
    const modesEl = document.getElementById("modes");

    let mode = localStorage.getItem(CONFIG.STORAGE_KEYS.mode) || "soft";

    function getCount() {
      const count = Number(localStorage.getItem(CONFIG.STORAGE_KEYS.count) || 0);
      return Number.isFinite(count) ? count : 0;
    }

    function setCount(value) {
      localStorage.setItem(CONFIG.STORAGE_KEYS.count, String(value));
      renderRemaining();
    }

    function getHistory() {
      try {
        const value = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.history) || "[]");
        return Array.isArray(value) ? value : [];
      } catch {
        return [];
      }
    }

    function setHistory(history) {
      localStorage.setItem(CONFIG.STORAGE_KEYS.history, JSON.stringify(history));
      renderHistory();
    }

    function renderRemaining() {
      const remaining = Math.max(0, CONFIG.LIMIT - getCount());
      remainingEl.textContent = `${remaining} r√©flexion(s) restante(s)`;
    }

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.classList.toggle("error", isError);
    }

    function locked() {
      window.location.href = CONFIG.STRIPE_LINK;
    }

    function renderModes() {
      modesEl.innerHTML = "";
      for (const item of MODES) {
        const button = document.createElement("button");
        button.type = "button";
        button.textContent = item.label;
        button.classList.toggle("active", item.id === mode);
        button.addEventListener("click", () => {
          if (item.locked) return locked();
          mode = item.id;
          localStorage.setItem(CONFIG.STORAGE_KEYS.mode, mode);
          renderModes();
        });
        modesEl.appendChild(button);
      }
    }

    function renderHistory() {
      const history = getHistory();
      historyEl.innerHTML = "";

      if (history.length === 0) {
        const empty = document.createElement("li");
        empty.textContent = "Aucune r√©flexion pour le moment.";
        historyEl.appendChild(empty);
        return;
      }

      for (const item of history) {
        const li = document.createElement("li");
        li.textContent = item;
        historyEl.appendChild(li);
      }
    }

    function getApiKey() {
      const key = (window.REFLECT_API_KEY || localStorage.getItem(CONFIG.STORAGE_KEYS.apiKey) || "").trim();
      return key;
    }

    async function reflect() {
      const currentCount = getCount();
      if (currentCount >= CONFIG.LIMIT) return locked();

      const input = inputEl.value.trim();
      if (!input) {
        setStatus("Ajoute un texte avant de lancer REFLECT.", true);
        return;
      }

      const apiKey = getApiKey();
      if (!apiKey) {
        setStatus("API key manquante. D√©finis window.REFLECT_API_KEY avant publication.", true);
        return;
      }

      reflectBtn.disabled = true;
      setStatus("Reflecting...");
      outputEl.textContent = "";

      const systemPrompt = `You are REFLECT.\nMode: ${mode.toUpperCase()}\n\nStructure EXACTLY:\n1. WHAT YOU SAY\n2. WHAT IT REVEALS\n3. THE MOST LIKELY TRUTH\n\nNo advice. No reassurance. Calm. Honest.`;

      try {
        const res = await fetch(CONFIG.API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: CONFIG.MODEL,
            temperature: 0.3,
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: input }
            ]
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API ${res.status} - ${text || "Unknown error"}`);
        }

        const data = await res.json();
        const reply = data?.choices?.[0]?.message?.content || "Aucune r√©ponse re√ßue.";

        outputEl.textContent = reply;

        const nextHistory = [reply, ...getHistory()].slice(0, 20);
        setHistory(nextHistory);
        setCount(currentCount + 1);
        setStatus("Termin√©.");
      } catch (error) {
        setStatus(`Erreur: ${error.message}`, true);
      } finally {
        reflectBtn.disabled = false;
      }
    }

    document.getElementById("clearHistoryBtn").addEventListener("click", () => {
      localStorage.removeItem(CONFIG.STORAGE_KEYS.history);
      localStorage.removeItem(CONFIG.STORAGE_KEYS.count);
      outputEl.textContent = "";
      setStatus("Historique effac√©.");
      renderHistory();
      renderRemaining();
    });

    reflectBtn.addEventListener("click", reflect);
    renderModes();
    renderHistory();
    renderRemaining();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(() => {
        setStatus("Mode hors-ligne non disponible sur ce navigateur.", true);
      });
    }
  </script>
</body>
</html>
